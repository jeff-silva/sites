<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gerador de Certificados - Dashboard</title>
    <!-- Vue.js -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ExcelJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
    <!-- JSZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
      tailwind.config = {
        darkMode: 'media',
        theme: {
          extend: {
            colors: {
              slate: { 850: '#1e293b' }
            }
          }
        }
      }
    </script>
    <style>
      body { font-family: 'Inter', sans-serif; }
      @keyframes indeterminate-bar {
          0% { width: 0%; margin-left: 0; }
          50% { width: 50%; margin-left: 25%; }
          100% { width: 100%; margin-left: 100%; }
      }
      .animate-indeterminate-bar { animation: indeterminate-bar 1.5s infinite linear; }
    </style>
  </head>
  <body class="bg-gray-50 dark:bg-slate-950 font-sans overflow-hidden text-slate-800 dark:text-slate-200">
    <div id="app" class="flex flex-col md:flex-row h-screen w-full">
      
      <!-- SIDEBAR (Desktop) -->
      <aside class="hidden md:flex w-72 flex-col bg-slate-900 text-white flex-shrink-0 border-r border-slate-800 z-20">
        <!-- Brand -->
        <div class="h-20 flex items-center px-8 border-b border-white/10">
           <div class="w-8 h-8 bg-white text-slate-900 flex items-center justify-center font-bold text-lg mr-3 rounded-sm">
             C
           </div>
           <div>
             <h1 class="font-bold text-lg tracking-wide uppercase">CertGenerator</h1>
             <p class="text-[10px] text-slate-400 font-mono tracking-widest uppercase">Pro Edition</p>
           </div>
        </div>

        <!-- Steps Nav -->
        <nav class="flex-1 py-8 px-4 space-y-1 overflow-y-auto">
           <div v-for="(s, index) in steps" :key="index" class="relative group">
              <!-- Connector Line -->
              <div v-if="index < steps.length - 1" class="absolute left-3.5 top-8 bottom-[-8px] w-px bg-white/10 group-hover:bg-white/20 transition-colors"></div>
              
              <div 
                class="flex items-center gap-4 p-3 rounded-sm transition-all duration-300"
                :class="step === index ? 'bg-white/10 border-l-2 border-white' : (step > index ? 'text-green-400' : 'text-slate-500')"
              >
                  <div 
                    class="w-7 h-7 flex items-center justify-center text-xs font-bold border rounded-sm transition-all z-10 bg-slate-900"
                    :class="step === index ? 'border-white text-white' : (step > index ? 'border-green-500 text-green-400' : 'border-slate-700 text-slate-600')"
                  >
                    <span v-if="step > index">‚úì</span>
                    <span v-else>{{ index + 1 }}</span>
                  </div>
                  <span class="text-xs font-bold uppercase tracking-widest">{{ s }}</span>
              </div>
           </div>
        </nav>

        <!-- Footer -->
        <div class="p-6 border-t border-white/10 text-xs text-slate-500 text-center">
            &copy; 2024 CertGenerator
        </div>
      </aside>

      <!-- MOBILE HEADER -->
      <header class="md:hidden h-16 bg-slate-900 text-white flex items-center justify-between px-4 flex-shrink-0 z-30 shadow-md w-full">
         <div class="flex items-center gap-3">
             <div class="w-8 h-8 bg-white text-slate-900 flex items-center justify-center font-bold text-sm rounded-sm">C</div>
             <span class="font-bold uppercase tracking-wider text-sm">{{ steps[step] }}</span>
         </div>
         <div class="text-xs font-mono text-slate-400">Step {{ step + 1 }}/5</div>
      </header>

      <!-- MAIN CONTENT -->
      <main class="flex-1 relative flex flex-col h-full overflow-hidden bg-white dark:bg-slate-950 w-full">
         
         <!-- Top Bar (Contextual Actions) -->
         <div v-if="step > 0 && step < 4" class="h-16 border-b border-slate-200 dark:border-slate-800 flex items-center justify-between px-6 sm:px-10 bg-white dark:bg-slate-950 flex-shrink-0 z-10">
             <h2 class="text-lg font-bold text-slate-800 dark:text-white uppercase tracking-tight hidden sm:block">
                 {{ step === 1 ? 'Biblioteca de Modelos' : (step === 2 ? 'Sele√ß√£o de Dados' : 'Editor de Mapeamento') }}
             </h2>
             
             <!-- Navigation Buttons -->
             <div class="flex items-center gap-3 ml-auto">
                 <button 
                   v-if="step === 2 && selectedFields.length > 0"
                   @click="goToMapping" 
                   class="px-6 py-2 bg-slate-900 dark:bg-white text-white dark:text-slate-900 text-xs font-bold uppercase tracking-widest hover:bg-slate-800 dark:hover:bg-slate-200 transition-all rounded-sm"
                 >
                    Continuar
                 </button>
                 <button 
                   v-if="step === 3"
                   @click="generateCertificates"
                   class="px-6 py-2 bg-emerald-600 text-white text-xs font-bold uppercase tracking-widest hover:bg-emerald-700 transition-all rounded-sm flex items-center gap-2"
                 >
                    <span>Finalizar</span>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                 </button>
             </div>
         </div>

         <!-- Scrollable Workspace -->
         <div class="flex-1 overflow-auto p-6 sm:p-10 relative scroll-smooth">
             
            <!-- STEP 0: Upload -->
            <div v-if="step === 0" class="h-full flex flex-col items-center justify-center">
                <div class="w-full max-w-2xl border border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 p-6 sm:p-12 text-center rounded-sm">
                    <div class="mb-8 inline-flex p-4 border border-slate-200 dark:border-slate-700 bg-white dark:bg-slate-900 text-3xl shadow-sm rotate-3 transform transition hover:rotate-6">
                      üìÇ
                    </div>
                    <h1 class="text-3xl font-bold text-slate-900 dark:text-white mb-4 uppercase tracking-tight">Iniciar Projeto</h1>
                    <p class="text-slate-500 mb-10 max-w-md mx-auto">Carregue sua fonte de dados (.xlsx) para come√ßar a automa√ß√£o.</p>
                    
                    <label class="block w-full h-48 border-2 border-dashed border-slate-300 dark:border-slate-700 hover:border-slate-500 dark:hover:border-slate-500 hover:bg-slate-100 dark:hover:bg-slate-800 transition-all cursor-pointer relative group">
                        <input type="file" class="hidden" accept=".xlsx" @change="handleFileUpload" />
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                            <span class="text-2xl text-slate-400 group-hover:text-slate-600 dark:group-hover:text-slate-300 transition-transform group-hover:-translate-y-1 mb-2">‚Üì</span>
                            <span class="text-sm font-bold uppercase tracking-widest text-slate-600 dark:text-slate-300">Arraste ou Clique</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- STEP 1: Templates -->
            <div v-if="step === 1" class="max-w-5xl mx-auto">
                <h3 class="text-xl font-bold text-slate-900 dark:text-white mb-2 uppercase tracking-tight block sm:hidden">Selecione o Modelo</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Default -->
                    <div @click="useDefaultTemplate" class="group cursor-pointer border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 hover:border-slate-400 dark:hover:border-slate-600 transition-all p-2 rounded-sm">
                        <div class="aspect-video bg-slate-100 dark:bg-slate-950 flex items-center justify-center p-4 overflow-hidden border border-slate-100 dark:border-slate-800">
                             <img src="./assets/default-model.svg" class="w-full shadow-lg group-hover:scale-105 transition-transform duration-500">
                        </div>
                        <div class="pt-4 px-2 pb-2 flex justify-between items-center">
                            <span class="font-bold text-sm uppercase tracking-wide">Modelo Padr√£o</span>
                            <span class="text-[10px] font-mono text-slate-400 px-2 py-1 bg-slate-100 dark:bg-slate-800">Classic</span>
                        </div>
                    </div>

                    <!-- Upload -->
                     <label class="group cursor-pointer border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 hover:border-slate-400 dark:hover:border-slate-600 transition-all p-2 rounded-sm relative">
                        <input type="file" class="hidden" accept="image/*" @change="handleTemplateUpload">
                        <div class="aspect-video bg-slate-50 dark:bg-slate-800 flex flex-col items-center justify-center gap-4 border border-dashed border-slate-200 dark:border-slate-700 group-hover:bg-slate-100 dark:group-hover:bg-slate-700 transition py-12">
                             <div class="w-12 h-12 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-600 flex items-center justify-center text-slate-400 group-hover:text-slate-900 dark:group-hover:text-white transition-colors">
                                +
                             </div>
                             <span class="text-xs font-bold uppercase tracking-widest text-slate-500">Fazer Upload</span>
                        </div>
                         <div class="pt-4 px-2 pb-2 flex justify-between items-center">
                            <span class="font-bold text-sm uppercase tracking-wide">Personalizado</span>
                            <span class="text-[10px] font-mono text-slate-400 px-2 py-1 bg-slate-100 dark:bg-slate-800">JPG/PNG</span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- STEP 2: Columns -->
             <div v-if="step === 2" class="max-w-4xl mx-auto h-full flex flex-col">
                 <div class="flex-1">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <label 
                          v-for="(header, index) in headers" 
                          :key="index"
                          class="relative p-4 border border-slate-200 dark:border-slate-800 cursor-pointer bg-white dark:bg-slate-900 hover:border-slate-400 dark:hover:border-slate-600 transition-all group"
                        >
                          <div class="flex items-center gap-3">
                              <div class="relative flex items-center">
                                <input type="checkbox" :value="header" v-model="selectedFields" class="peer appearance-none w-5 h-5 border border-slate-300 dark:border-slate-600 checked:bg-slate-900 dark:checked:bg-white checked:border-transparent transition-all rounded-sm">
                                <svg class="absolute w-3.5 h-3.5 text-white dark:text-slate-900 pointer-events-none opacity-0 peer-checked:opacity-100 left-0.5 top-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>
                              </div>
                              <span class="font-mono text-sm group-hover:text-slate-900 dark:group-hover:text-white transition-colors select-none truncate" :title="header">{{ header }}</span>
                          </div>
                        </label>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t border-slate-200 dark:border-slate-800 text-xs font-mono text-slate-500">
                    {{ selectedFields.length }} Colunas Selecionadas
                </div>
             </div>

             <!-- STEP 3: Mapping (Split Editor) -->
             <div v-show="step === 3" class="w-full min-h-full lg:h-full flex flex-col lg:flex-row gap-6">
                 <!-- Canvas Wrapper -->
                 <!-- Canvas Wrapper -->
                 <div ref="canvasStage" class="w-full lg:flex-1 bg-slate-100 dark:bg-slate-900 border border-slate-200 dark:border-slate-800 flex justify-center items-center overflow-hidden rounded-sm relative shadow-inner p-2 sm:p-4 min-h-[35vh] sm:min-h-[500px]">
                     
                     <!-- Scalable Container -->
                     <div :style="{ 
                        width: canvasDimensions.width + 'px', 
                        height: canvasDimensions.height + 'px',
                        transform: `scale(${canvasScale})`,
                        transformOrigin: 'center center',
                        transition: 'transform 0.1s ease-out'
                     }" class="relative shadow-xl">
                        <canvas id="certificateCanvas"></canvas>
                        
                        <!-- Instruction Overlay -->
                        <div v-if="selectedFields.length > 0 && !textObject" class="absolute top-4 left-4 bg-white/90 dark:bg-slate-900/90 backdrop-blur border border-slate-200 dark:border-slate-700 p-3 text-xs shadow-sm max-w-[200px] sm:max-w-xs pointer-events-none z-10">
                            <strong class="uppercase text-[10px] tracking-wider block mb-1 text-slate-500">Dica</strong>
                            Desenhe um ret√¢ngulo na imagem para posicionar o campo <b>{{ selectedFields[currentFieldIndex] }}</b>.
                        </div>
                     </div>

                 </div>

                 <!-- Tools sidebar -->
                 <div class="w-full lg:w-80 flex flex-col gap-px bg-slate-200 dark:bg-slate-800 p-px border border-slate-200 dark:border-slate-800 rounded-sm overflow-hidden">
                     
                     <!-- Field Tabs List -->
                     <div class="bg-white dark:bg-slate-950 p-4 max-h-48 overflow-y-auto border-b border-slate-100 dark:border-slate-800">
                         <h4 class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-3">Campos</h4>
                         <div class="space-y-1">
                             <button 
                               v-for="(field, idx) in selectedFields" 
                               :key="idx"
                               @click="switchTab(idx)"
                               class="w-full flex items-center justify-between px-3 py-2 text-xs font-medium border rounded-sm transition-all text-left"
                               :class="currentFieldIndex === idx ? 'bg-slate-50 dark:bg-slate-800 border-slate-900 dark:border-white text-slate-900 dark:text-white' : 'border-transparent text-slate-500 hover:bg-slate-50 dark:hover:bg-slate-900'"
                             >
                                <span class="truncate">{{ field }}</span>
                                <span class="w-2 h-2 rounded-full" :class="fieldConfigs[field] ? 'bg-emerald-500' : 'bg-slate-200 dark:bg-slate-700'"></span>
                             </button>
                         </div>
                     </div>

                     <!-- Properties -->
                     <div class="flex-1 bg-white dark:bg-slate-950 p-6 flex flex-col">
                         <h4 class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-6 flex justify-between items-center">
                             Propriedades
                             <span v-if="!textObject" class="text-orange-500 text-[9px] border border-orange-200 bg-orange-50 px-1 py-0.5 rounded-sm">Nenhuma sele√ß√£o</span>
                         </h4>
                         
                         <div class="space-y-6" :class="{ 'opacity-30 pointer-events-none filter grayscale': !textObject }">
                             <!-- Font Size -->
                             <div>
                                 <label class="flex justify-between text-[10px] font-bold uppercase tracking-wider mb-2">Tamanho <span class="text-slate-400">{{ currentProps.fontSize }}px</span></label>
                                 <div class="flex items-center gap-2">
                                     <button @click="adjustFontSize(-2)" class="w-8 h-8 bg-slate-100 dark:bg-slate-800 rounded-sm flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700">-</button>
                                     <input type="range" v-model.number="currentProps.fontSize" @input="updateActiveObject" min="10" max="200" class="flex-1 h-1 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer accent-slate-900 dark:accent-white">
                                     <button @click="adjustFontSize(2)" class="w-8 h-8 bg-slate-100 dark:bg-slate-800 rounded-sm flex items-center justify-center text-slate-600 dark:text-slate-300 hover:bg-slate-200 dark:hover:bg-slate-700">+</button>
                                 </div>
                             </div>

                             <!-- Alignment -->
                             <div>
                                 <label class="text-[10px] font-bold uppercase tracking-wider mb-2 block">Alinhamento</label>
                                 <div class="flex border border-slate-200 dark:border-slate-800 rounded-sm overflow-hidden">
                                     <button @click="setAlignment('left')" class="flex-1 py-2 hover:bg-slate-50 dark:hover:bg-slate-800" :class="currentProps.textAlign === 'left' ? 'bg-slate-100 dark:bg-slate-800 text-black dark:text-white' : 'text-slate-400'"><svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h10M4 18h16"></path></svg></button>
                                     <button @click="setAlignment('center')" class="border-l border-r border-slate-200 dark:border-slate-800 flex-1 py-2 hover:bg-slate-50 dark:hover:bg-slate-800" :class="currentProps.textAlign === 'center' ? 'bg-slate-100 dark:bg-slate-800 text-black dark:text-white' : 'text-slate-400'"><svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg></button>
                                     <button @click="setAlignment('right')" class="flex-1 py-2 hover:bg-slate-50 dark:hover:bg-slate-800" :class="currentProps.textAlign === 'right' ? 'bg-slate-100 dark:bg-slate-800 text-black dark:text-white' : 'text-slate-400'"><svg class="w-4 h-4 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M10 12h10M4 18h16"></path></svg></button>
                                 </div>
                             </div>

                             <!-- Color -->
                             <div>
                                <label class="text-[10px] font-bold uppercase tracking-wider mb-2 block">Cor</label>
                                <div class="flex items-center gap-3">
                                   <input type="color" v-model="currentProps.fill" @input="updateActiveObject" class="w-8 h-8 p-0 border-0 rounded-sm cursor-pointer ring-1 ring-slate-200 dark:ring-slate-700">
                                   <span class="text-xs font-mono text-slate-500">{{ currentProps.fill }}</span>
                                </div>
                             </div>

                             <button @click="resetTextObject" class="w-full mt-4 py-2 border border-red-200 dark:border-red-900 text-red-600 dark:text-red-400 text-xs font-bold uppercase hover:bg-red-50 dark:hover:bg-red-950/30 transition-colors rounded-sm">
                                 Remover Mapping
                             </button>
                         </div>
                     </div>
                 </div>
             </div>

             <!-- RESULTS SCREEN -->
             <div v-if="step === 4" class="h-full flex flex-col items-center justify-center p-8 text-center bg-slate-50 dark:bg-slate-950 to-white">
                 <div class="max-w-xl w-full bg-white dark:bg-slate-900 p-12 border border-slate-200 dark:border-slate-800 shadow-xl relative overflow-hidden">
                     <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-slate-900 via-slate-500 to-slate-900 dark:from-white dark:via-slate-500 dark:to-white"></div>
                     
                     <div class="mb-8 w-20 h-20 bg-slate-900 text-white mx-auto flex items-center justify-center text-3xl font-serif">
                         ‚úì
                     </div>
                     
                     <h2 class="text-4xl font-bold text-slate-900 dark:text-white mb-4 tracking-tighter">Processo Conclu√≠do</h2>
                     <p class="text-slate-500 dark:text-slate-400 mb-10 text-lg">
                         Foram gerados <strong class="text-slate-900 dark:text-white">{{ generatedImages.length }}</strong> documentos com sucesso.
                     </p>

                     <div class="flex flex-col gap-3">
                         <button @click="downloadZip" class="w-full py-4 bg-slate-900 dark:bg-white text-white dark:text-slate-900 font-bold uppercase tracking-widest hover:opacity-90 transition shadow-lg flex items-center justify-center gap-3">
                             <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                             Baixar ZIP
                         </button>
                         <div class="grid grid-cols-2 gap-3">
                             <button @click="backToAdjust" class="py-3 border border-slate-300 dark:border-slate-700 font-bold uppercase text-xs tracking-widest hover:border-slate-900 dark:hover:border-white transition-colors">Voltar</button>
                             <button @click="reset" class="py-3 border border-transparent text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 font-bold uppercase text-xs tracking-widest transition-colors">Novo Projeto</button>
                         </div>
                     </div>
                 </div>
             </div>

             <!-- LOADER -->
             <transition name="fade">
                 <div v-if="isGenerating" class="absolute inset-0 z-50 bg-white/90 dark:bg-slate-950/95 backdrop-blur-sm flex flex-col items-center justify-center">
                     <div class="w-24 h-1 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden mb-4">
                         <div class="h-full bg-slate-900 dark:bg-white animate-indeterminate-bar"></div>
                     </div>
                     <span class="font-mono text-xs uppercase tracking-widest text-slate-500">Gerando arquivos...</span>
                 </div>
             </transition>
         </div>
      </main>
    </div>
    
    <script>
      const { createApp } = Vue;

      createApp({
        data() {
          return {
            step: 0,
            steps: ['Excel', 'Modelo', 'Colunas', 'Mapeamento', 'Download'],
            excelHeaders: [],
            excelRows: [],
            selectedFields: [], 
            
            // Logic State
            currentFieldIndex: 0,
            textObject: null, // Current active field object
            fieldConfigs: {}, // Stores config for each field { header: { left, top, width, ... } }
            
            // Drawing
            drawingRect: null,
            isDrawing: false,
            origX: 0,
            origY: 0,

            templateUrl: null,
            canvas: null,
            
            // default props for new fields
            currentProps: {
              fontSize: 40,
              fill: '#000000',
              textAlign: 'center'
            },

            generatedImages: [],
            isGenerating: false,
            
            // Responsive Canvas
            canvasScale: 1,
            canvasDimensions: { width: 800, height: 600 },
            resizeObserver: null,
          }
        },
        computed: {
            headers() {
              return this.excelHeaders;
            },
            currentField() {
                // Returns the current field name or safely fallback
                return this.selectedFields[this.currentFieldIndex] || '';
            },
            isLastField() {
                // Correct logic: if we are at the last index
                return this.currentFieldIndex >= (this.selectedFields.length - 1);
            }
        },
        methods: {
          async handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const workbook = new ExcelJS.Workbook();
            const reader = new FileReader();

            reader.onload = async (e) => {
              const buffer = e.target.result;
              await workbook.xlsx.load(buffer);
              const worksheet = workbook.getWorksheet(1);

              const rows = [];
              worksheet.eachRow((row, rowNumber) => {
                if (rowNumber === 1) {
                  this.excelHeaders = row.values.slice(1);
                } else {
                  // Map row values, handling Date objects and Rich Text
                  const rowData = row.values.slice(1).map(val => {
                      if (val && typeof val === 'object') {
                          // If it's a JS Date (ExcelJS automatically converts dates)
                          if (val instanceof Date) {
                              // We want the text format, but ExcelJS gives us a Date.
                              // Let's format it simply to DD/MM/YYYY or similar if needed, 
                              // OR if the user wants "Text as in Excel", sadly ExcelJS might have already parsed it.
                              // Best effort: Format as Locale Date String to match typical expected output
                              return val.toLocaleDateString('pt-BR');
                          }
                          // Handle Rich Text (cell has .text property)
                          if (val.text) return val.text;
                          // Handle Hyperlinks (cell has .text or .hyperlink)
                          return val.text || val.toString();
                      }
                      return val;
                  });
                  rows.push(rowData);
                }
              });

              this.excelRows = rows;
              if(this.excelHeaders.length > 0) {
                 this.step = 1; // Go to Model Selection
              } else {
                alert('N√£o foi poss√≠vel ler os cabe√ßalhos do arquivo.');
              }
            };

            reader.readAsArrayBuffer(file);
          },

          useDefaultTemplate() {
            // SVG Content with Portuguese characters
            const svgContent = `<svg width="800" height="600" xmlns="http://www.w3.org/2000/svg"><rect width="800" height="600" fill="#ffffff" /><rect x="20" y="20" width="760" height="560" fill="none" stroke="#B8860B" stroke-width="5" /><rect x="30" y="30" width="740" height="540" fill="none" stroke="#DAA520" stroke-width="2" /><path d="M 30 30 L 130 30 L 130 130 L 30 30" fill="#DAA520" opacity="0.2" /><path d="M 770 30 L 670 30 L 670 130 L 770 30" fill="#DAA520" opacity="0.2" /><path d="M 30 570 L 130 570 L 30 470 L 30 570" fill="#DAA520" opacity="0.2" /><path d="M 770 570 L 670 570 L 770 470 L 770 570" fill="#DAA520" opacity="0.2" /><text x="400" y="150" font-family="serif" font-size="50" font-weight="bold" fill="#333" text-anchor="middle">CERTIFICADO</text><text x="400" y="200" font-family="sans-serif" font-size="20" fill="#666" text-anchor="middle" letter-spacing="5">DE PARTICIPA√á√ÉO</text><text x="400" y="280" font-family="sans-serif" font-size="16" fill="#555" text-anchor="middle">Este certificado √© orgulhosamente concedido a</text><text x="400" y="450" font-family="sans-serif" font-size="16" fill="#555" text-anchor="middle">por sua participa√ß√£o e dedica√ß√£o excepcionais.</text><line x1="150" y1="520" x2="350" y2="520" stroke="#333" stroke-width="1" /><text x="250" y="540" font-family="sans-serif" font-size="14" fill="#666" text-anchor="middle">Data</text><line x1="450" y1="520" x2="650" y2="520" stroke="#333" stroke-width="1" /><text x="550" y="540" font-family="sans-serif" font-size="14" fill="#666" text-anchor="middle">Assinatura</text><circle cx="400" cy="500" r="30" fill="#B8860B" opacity="0.1" /><circle cx="400" cy="500" r="25" fill="none" stroke="#B8860B" stroke-width="2" /></svg>`;
            
            const encodedSvg = btoa(unescape(encodeURIComponent(svgContent)));
            this.templateUrl = 'data:image/svg+xml;base64,' + encodedSvg;
            
            this.step = 2; // Move to Columns
          },

          handleTemplateUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
               this.templateUrl = e.target.result;
               this.step = 2; // Move to Columns
            };
            reader.readAsDataURL(file);
          },

          // Step 1 -> Step 2
          goToColumns() {
             this.step = 2;
          },

          // Step 2 -> Step 3
          goToMapping() {
             if(this.selectedFields.length === 0) return;
             
             // Set to -1 to ensure switchTab(0) detects a change and initializes the first tab correctly
             this.currentFieldIndex = -1; 
             
             this.fieldConfigs = {}; // Reset configs
             this.initCanvas();
          },
          
          async initCanvas() {
            this.step = 3;
            await this.$nextTick();

            if(this.canvas) {
                this.canvas.dispose();
            }

            // Init fabric
            this.canvas = new fabric.Canvas('certificateCanvas', {
              width: 800,
              height: 600,
              selection: false 
            });

            // Load Image
            fabric.Image.fromURL(this.templateUrl, (img) => {
               if(!img) { alert('Erro na imagem'); return; }

               this.canvas.setWidth(img.width);
               this.canvas.setHeight(img.height);
               this.canvas.setBackgroundImage(img, this.canvas.renderAll.bind(this.canvas));

               // Store dims for scaling logic
               this.canvasDimensions = { width: img.width, height: img.height };
               // Calculate initial scale
               this.updateLayoutScale();

               // Start at first tab
               this.switchTab(0);

            }, { crossOrigin: null });
          },

          switchTab(index) {
             // 0. Safety check
             if (index === this.currentFieldIndex) return;

             // 1. Identify fields
             const oldField = this.selectedFields[this.currentFieldIndex];
             const newField = this.selectedFields[index];

             // 2. Save current state explicitly using the OLD field name
             if (oldField && this.textObject) {
                 this.saveConfigForField(oldField);
             }

             // 3. Update Index
             this.currentFieldIndex = index;

             // 4. Clear Canvas safely
             // Remove all objects to start fresh for the new view
             const objects = this.canvas.getObjects();
             this.canvas.remove(...objects);
             this.textObject = null;
             
             // 5. Draw Ghosts (All fields except the new current one)
             this.selectedFields.forEach((field, idx) => {
                  if (idx !== index) {
                      const cfg = this.fieldConfigs[field];
                      if (cfg) {
                           const t = new fabric.Textbox(this.getSampleValue(field), {
                                left: cfg.left,
                                top: cfg.top,
                                width: cfg.width,
                                fontSize: cfg.fontSize,
                                textAlign: cfg.textAlign,
                                fill: cfg.fill,
                                opacity: 0.5, // Dimmed ghost
                                selectable: false,
                                evented: false,
                                originX: 'center',
                                originY: 'center'
                           });
                           this.canvas.add(t);
                      }
                  }
             });

             // 6. Restore Active Field or Enable Drawing
             const savedConfig = this.fieldConfigs[newField];

             if (savedConfig) {
                 // Restoration
                 this.isDrawing = false;
                 this.disableDrawingMode();
                 
                 // Restore internal props for the UI controls
                 this.currentProps = { 
                     fontSize: savedConfig.fontSize,
                     fill: savedConfig.fill,
                     textAlign: savedConfig.textAlign,
                     width: savedConfig.width
                 };

                 this.spawnTextbox(savedConfig);
                 
             } else {
                 // New Mapping
                 this.currentProps = { fontSize: 40, fill: '#000000', textAlign: 'center' };
                 this.enableDrawingMode();
             }
             
             this.canvas.requestRenderAll();
          },

          // Replaces saveCurrentConfig with a parameterized version
          saveConfigForField(fieldName) {
              if(!this.textObject) return;
              
              const scaledWidth = this.textObject.width * this.textObject.scaleX;
              
              this.fieldConfigs[fieldName] = {
                  left: this.textObject.left,
                  top: this.textObject.top,
                  width: scaledWidth,
                  fontSize: this.textObject.fontSize,
                  fill: this.textObject.fill, // Use object's fill as source of truth
                  textAlign: this.textObject.textAlign
              };
          },
          
          // Alias for backward compatibility if needed, but we use saveConfigForField now
          saveCurrentConfig() {
              this.saveConfigForField(this.currentField);
          },

          // Helper to get real data for preview
          getSampleValue(header) {
              if (!header) return '...';
              const idx = this.excelHeaders.indexOf(header);
              if(this.excelRows.length > 0 && idx > -1) {
                  const val = this.excelRows[0][idx];
                  return val ? String(val) : `[${header}]`;
              }
              return `[${header}]`;
          },

          enableDrawingMode() {
              if(!this.canvas) return;
              this.disableDrawingMode(); // cleanup

              this.canvas.discardActiveObject();
              this.canvas.requestRenderAll();

              this.canvas.defaultCursor = 'crosshair';
              this.canvas.selection = false; 
              this.canvas.skipTargetFind = true; 

              this.canvas.on('mouse:down', this.startDrawing);
              this.canvas.on('mouse:move', this.processDrawing);
              this.canvas.on('mouse:up', this.endDrawing);
          },

          disableDrawingMode() {
              if(!this.canvas) return;
              
              this.canvas.defaultCursor = 'default';
              this.canvas.selection = false; // Keep false usually
              this.canvas.skipTargetFind = false;

              this.canvas.off('mouse:down', this.startDrawing);
              this.canvas.off('mouse:move', this.processDrawing);
              this.canvas.off('mouse:up', this.endDrawing);
          },

          startDrawing(o) {
              if (this.textObject) return; 
              const pointer = this.canvas.getPointer(o.e);
              this.origX = pointer.x;
              this.origY = pointer.y;
              this.isDrawing = true;

              this.drawingRect = new fabric.Rect({
                  left: this.origX,
                  top: this.origY,
                  originX: 'left',
                  originY: 'top',
                  width: pointer.x - this.origX,
                  height: pointer.y - this.origY,
                  fill: 'rgba(99, 102, 241, 0.3)',
                  stroke: '#4f46e5',
                  strokeWidth: 2,
                  selectable: false 
              });
              this.canvas.add(this.drawingRect);
          },

          processDrawing(o) {
              if (!this.isDrawing) return;
              const pointer = this.canvas.getPointer(o.e);

              if (this.origX > pointer.x) {
                  this.drawingRect.set({ left: Math.abs(pointer.x) });
              }
              if (this.origY > pointer.y) {
                  this.drawingRect.set({ top: Math.abs(pointer.y) });
              }

              this.drawingRect.set({ width: Math.abs(this.origX - pointer.x) });
              this.drawingRect.set({ height: Math.abs(this.origY - pointer.y) });

              this.canvas.renderAll();
          },

          endDrawing(o) {
              if (!this.isDrawing) return;
              this.isDrawing = false;
              
              const width = this.drawingRect.width;
              const height = this.drawingRect.height;
              const left = this.drawingRect.left;
              const top = this.drawingRect.top + (height / 2); 
              
              this.canvas.remove(this.drawingRect);
              this.drawingRect = null;

              if(width < 20) return; 

              this.disableDrawingMode();
              
              // Define default props based on drawing
              const config = {
                  left: left + (width/2),
                  top: top,
                  width: width,
                  fontSize: 40,
                  fill: '#000000',
                  textAlign: 'center'
              };
              
              // Update currentProps to match defaults so UI is synced
              this.currentProps = { ...config };
              
              this.spawnTextbox(config);
          },

          spawnTextbox(config) {
               // Use Sample Value instead of placeholder
               const textValue = this.getSampleValue(this.currentField);

               this.textObject = new fabric.Textbox(textValue, {
                 left: config.left,
                 top: config.top,
                 originX: 'center', 
                 originY: 'center',
                 width: config.width,
                 fontFamily: 'Inter',
                 fontSize: config.fontSize,
                 fill: config.fill,
                 textAlign: config.textAlign,
                 transparentCorners: false,
                 cornerColor: '#0f172a', // slate-900
                 cornerStyle: 'circle',
                 borderColor: '#0f172a',
               });
               
               this.canvas.add(this.textObject);
               this.canvas.setActiveObject(this.textObject);
               
               // Sync Active Object changes to UI Props
               this.textObject.on('modified', () => {
                   this.currentProps.fontSize = this.textObject.fontSize;
                   this.currentProps.width = this.textObject.getScaledWidth();
               });
          },
          
          resetTextObject() {
              if(this.textObject) {
                  this.canvas.remove(this.textObject);
                  this.textObject = null;
                  
                  // Also clear from config so the dot indicator disappears
                  delete this.fieldConfigs[this.currentField];
              }
              this.enableDrawingMode();
          },

          adjustFontSize(delta) {
             if(this.textObject) {
                 this.currentProps.fontSize += delta;
                 this.updateActiveObject();
             }
          },
          
          setAlignment(align) {
              this.currentProps.textAlign = align;
              this.updateActiveObject();
          },

          // Replaces updateActiveObject
          updateActiveObject() {
             if (this.textObject) {
                this.textObject.set({
                  fontSize: this.currentProps.fontSize,
                  fill: this.currentProps.fill,
                  width: this.currentProps.width,
                  textAlign: this.currentProps.textAlign,
                  scaleX: 1, 
                  scaleY: 1
                });
                this.canvas.renderAll();
             }
          },

          async generateCertificates() {
            // Save state of current tab before starting
            if(this.textObject) this.saveCurrentConfig();

            // Check if we have configs
            if(Object.keys(this.fieldConfigs).length === 0) {
                alert('Voc√™ precisa mapear pelo menos um campo antes de gerar.');
                return;
            }

            this.isGenerating = true;
            this.generatedImages = [];

            setTimeout(async () => {
               // 1. Clear Canvas
               this.canvas.getObjects().forEach(o => this.canvas.remove(o));
               
               // 2. Create the "Template" Textboxes based on saved configs
               const map = {};
               this.selectedFields.forEach(header => {
                   const conf = this.fieldConfigs[header];
                   if(!conf) return; // skip unmapped fields

                   // Use conf.fill for the real color
                   const box = new fabric.Textbox('', {
                       ...conf,
                       fill: conf.fill, // Ensure normal opacity
                       selectable: false,
                       originX: 'center',
                       originY: 'center'
                   });
                   this.canvas.add(box);
                   map[header] = box;
               });
               
               // 3. Loop
               this.excelRows.forEach(row => {
                  let hasContent = false;
                  this.selectedFields.forEach(header => {
                     const obj = map[header];
                     if(obj) {
                        const colIndex = this.excelHeaders.indexOf(header);
                        const val = row[colIndex] || '';
                        
                        // Set text
                        obj.set({ text: String(val) });
                        hasContent = true;
                     }
                  });

                  if(!hasContent) return; // Skip empty rows

                  // Render and Snap
                  this.canvas.renderAll();
                  const dataURL = this.canvas.toDataURL({
                      format: 'png',
                      quality: 0.9 
                  });
                  
                  // Generate File Name
                  const nameIdx = this.excelHeaders.findIndex(h => h.toLowerCase().includes('nome') || h.toLowerCase().includes('name') || h.toLowerCase().includes('aluno'));
                  let fileName = 'certificado';
                  if(nameIdx > -1 && row[nameIdx]) {
                      fileName += '_' + String(row[nameIdx]).replace(/[^a-z0-9]/gi, '_');
                  } else {
                      fileName += '_' + Math.random().toString(36).substr(2, 5); // unique id
                  }

                  this.generatedImages.push({
                      name: fileName,
                      url: dataURL
                  });
               });

               this.isGenerating = false;
               this.step = 4; // Show results

            }, 100); // Small delay to let UI update loader
          },

          downloadZip() {
             const zip = new JSZip();
             
             this.generatedImages.forEach(img => {
                 const base64Data = img.url.replace(/^data:image\/(png|jpg);base64,/, "");
                 zip.file(`${img.name}.png`, base64Data, {base64: true});
             });
             
             zip.generateAsync({type:"blob"}).then(function(content) {
                 const link = document.createElement('a');
                 link.href = URL.createObjectURL(content);
                 link.download = "certificados.zip";
                 link.click();
             });
          },

          backToAdjust() {
              this.currentFieldIndex = -1; 
              this.initCanvas();
              this.step = 3; 
          },

          reset() {
            window.location.reload();
          },

          updateLayoutScale() {
              if(!this.$refs.canvasStage) return;
              
              // Get available space in the container
              const stageWidth = this.$refs.canvasStage.clientWidth;
              const stageHeight = this.$refs.canvasStage.clientHeight;
              
              if (stageWidth <= 0 || stageHeight <= 0) return;
              
              const imgW = this.canvasDimensions.width;
              const imgH = this.canvasDimensions.height;
              
              // Padding/Safety margin
              const padding = 32; 
              
              const availableW = Math.max(0, stageWidth - padding);
              const availableH = Math.max(0, stageHeight - padding);

              // Calculate ratios
              const scaleW = availableW / imgW;
              const scaleH = availableH / imgH;
              
              // Fit Contain
              let scale = Math.min(scaleW, scaleH);
              
              // Cap limits
              if(scale > 1) scale = 1; 
              if(scale < 0.1) scale = 0.1; // Minimum visible scale
              
              this.canvasScale = scale || 1;
          }
        },
        mounted() {
           window.addEventListener('resize', this.updateLayoutScale);
           
           // Also observe the container specifically in case of flex resizing
           if(this.$refs.canvasStage) {
               this.resizeObserver = new ResizeObserver(() => this.updateLayoutScale());
               this.resizeObserver.observe(this.$refs.canvasStage);
           }
        },
        beforeUnmount() {
            window.removeEventListener('resize', this.updateLayoutScale);
            if(this.resizeObserver) this.resizeObserver.disconnect();
        }
      }).mount('#app');
    </script>
  </body>
</html>